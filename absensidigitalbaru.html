<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Digital SMA Negeri 1 Banggai</title>
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.dropbox.com/scl/fi/6zo10ygbta4nh7pqy6njp/pavicon.png?rlkey=dkedqmucgum5two8wyafjghjn&st=vst7ardt&dl=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        @keyframes slideOut {
            from { opacity: 1; transform: translateX(0) scale(1); }
            to { opacity: 0; transform: translateX(-150px) scale(0.7); }
        }
        @keyframes colorTransition {
            0% { background-color: rgb(59, 130, 246); }
            50% { background-color: rgb(249, 115, 22); }
            100% { background-color: rgb(239, 68, 68); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
            40%, 43% { transform: translateY(-10px); }
            70% { transform: translateY(-5px); }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
        }
        
        .slide-in { animation: slideIn 0.6s ease-out; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .shake { animation: shake 0.8s ease-in-out; }
        .slide-out { animation: slideOut 0.6s ease-in-out forwards; }
        .color-transition { animation: colorTransition 0.8s ease-in-out; }
        .pulse { animation: pulse 2s infinite; }
        .bounce { animation: bounce 1s; }
        .glow { animation: glow 2s infinite; }
        
        .hover-scale:hover { 
            transform: scale(1.1); 
            transition: transform 0.3s ease; 
        }
        .hover-lift:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
            transition: all 0.3s ease; 
        }
        .status-btn { 
            transition: all 0.3s ease; 
            position: relative;
            overflow: hidden;
        }
        .status-btn:hover { 
            transform: translateY(-2px) scale(1.05); 
            box-shadow: 0 6px 20px rgba(0,0,0,0.2); 
        }
        .status-btn:active { 
            transform: scale(0.95); 
        }
        .student-row { 
            transition: all 0.4s ease; 
            position: relative;
        }
        .student-row:hover { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(147, 51, 234, 0.08));
            transform: translateX(5px);
        }
        .delete-preparing { 
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15)) !important; 
            border-left: 4px solid #ef4444;
        }
        .selected-for-delete {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
            border: 2px solid #ef4444;
            transform: scale(0.98);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
        .ripple {
            position: relative;
            overflow: hidden;
        }
        .ripple:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .ripple:active:before {
            width: 300px;
            height: 300px;
        }
        [contenteditable]:hover {
            background-color: #ebf8ff;
            outline: 2px solid #3b82f6;
        }
        [contenteditable]:focus {
            background-color: #dbeafe;
            outline: 2px solid #2563eb;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-100 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white p-8 shadow-2xl slide-in">
        <div class="container mx-auto text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-3 glow">ABSENSI DIGITAL</h1>
            <h2 class="text-2xl md:text-3xl font-semibold mb-2">SMA NEGERI 1 BANGGAI</h2>
            <p class="text-xl mt-3 opacity-90">TAHUN PELAJARAN 2025/2026</p>
            <div class="mt-4 flex justify-center">
                <div class="bg-white bg-opacity-20 rounded-full px-6 py-2">
                    <span id="currentDateTime" class="text-lg font-medium"></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="glass-effect shadow-lg p-4 fade-in sticky top-0 z-40">
        <div class="container mx-auto">
            <div class="flex flex-wrap justify-center gap-3">
                <button onclick="showTab('absensi')" class="nav-btn bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                    üìã Absensi
                </button>
                <button onclick="showTab('statistik')" class="nav-btn bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                    üìä Statistik
                </button>
                <button onclick="showTab('rekap')" class="nav-btn bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                    üìà Rekap
                </button>
                <button onclick="showTab('pengaturan')" class="nav-btn bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                    ‚öôÔ∏è Pengaturan
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto p-6">
        <!-- Tab Absensi -->
        <div id="absensi-tab" class="tab-content">
            <!-- Class Selection -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 mb-8 slide-in card-shadow">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3">Pilih Kelas:</label>
                        <select id="classSelect" onchange="changeClass()" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            <option value="XI-F">XI F</option>
                            <option value="X-A">X A</option>
                            <option value="X-B">X B</option>
                            <option value="X-C">X C</option>
                            <option value="X-D">X D</option>
                            <option value="X-E">X E</option>
                            <option value="X-F">X F</option>
                            <option value="X-G">X G</option>
                            <option value="X-H">X H</option>
                        </select>
                    </div>
                     <div>
                        <label for="attendanceDate" class="block text-sm font-bold text-gray-700 mb-3">Tanggal Absensi:</label>
                        <input type="date" id="attendanceDate" onchange="changeDate(this.value)" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3">Wali Kelas:</label>
                        <input type="text" id="waliKelas" placeholder="Nama Wali Kelas" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3 mb-6">
                    <button onclick="addStudent()" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                        ‚ûï Tambah Siswa
                    </button>
                    <button onclick="markAllPresent()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                        ‚úÖ Hadir Semua
                    </button>
                    <button onclick="toggleBulkDelete()" id="bulkDeleteBtn" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                        üóëÔ∏è Hapus Massal
                    </button>
                    <button onclick="saveData()" class="bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                        üíæ Simpan Data
                    </button>
                    <button onclick="exportToExcel()" class="bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                        üìä Export Excel
                    </button>
                </div>

                <!-- Bulk Delete Controls -->
                <div id="bulkDeleteControls" class="hidden mb-6 p-6 bg-gradient-to-r from-red-50 to-pink-50 rounded-2xl border-2 border-red-200">
                    <div class="flex flex-wrap gap-3 items-center">
                        <button onclick="selectAllForDelete()" class="bg-red-400 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-sm transition-all hover-lift">
                            ‚úì Pilih Semua
                        </button>
                        <button onclick="deselectAllForDelete()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg text-sm transition-all hover-lift">
                            ‚úó Batal Pilih
                        </button>
                        <button onclick="deleteSelectedStudents()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm transition-all hover-lift pulse">
                            üóëÔ∏è Hapus Terpilih (<span id="selectedCount">0</span>)
                        </button>
                        <button onclick="toggleBulkDelete()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition-all hover-lift">
                            ‚ùå Selesai
                        </button>
                    </div>
                </div>

                <!-- Undo Button -->
                <div id="undoContainer" class="hidden mb-6">
                    <button onclick="undoDelete()" class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white px-6 py-3 rounded-xl transition-all hover-lift bounce">
                        ‚Ü∂ Batalkan Penghapusan (<span id="undoCount">0</span> item)
                    </button>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-green-400 to-green-500 text-white p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold" id="hadirCount">0</div>
                        <div class="text-sm">Hadir</div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 text-white p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold" id="sakitCount">0</div>
                        <div class="text-sm">Sakit</div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-400 to-blue-500 text-white p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold" id="izinCount">0</div>
                        <div class="text-sm">Izin</div>
                    </div>
                    <div class="bg-gradient-to-r from-red-400 to-red-500 text-white p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold" id="alphaCount">0</div>
                        <div class="text-sm">Alpha</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-400 to-purple-500 text-white p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold" id="bolosCount">0</div>
                        <div class="text-sm">Bolos</div>
                    </div>
                    <div class="bg-gradient-to-r from-orange-400 to-orange-500 text-white p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold" id="terlambatCount">0</div>
                        <div class="text-sm">Terlambat</div>
                    </div>
                </div>
            </div>

            <!-- Student List -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 slide-in card-shadow">
                <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                    üë• Daftar Siswa 
                    <span class="ml-3 bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-lg" id="totalStudents">0</span>
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gradient-to-r from-gray-50 to-gray-100">
                                <th class="p-4 text-left font-bold">No</th>
                                <th class="p-4 text-left font-bold">Nama Siswa</th>
                                <th class="p-4 text-left font-bold">NISN</th>
                                <th class="p-4 text-center font-bold">Status Kehadiran</th>
                                <th class="p-4 text-center font-bold">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentList">
                            <!-- Students will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Statistik -->
        <div id="statistik-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Monthly Statistics -->
                <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                        üìà Statistik Bulanan
                        <select id="monthlyStudentSelect" onchange="updateMonthlyChart()" class="ml-4 p-2 border rounded-lg text-sm">
                            <option value="all">Semua Siswa</option>
                        </select>
                    </h3>
                    <canvas id="monthlyChart" width="400" height="300"></canvas>
                </div>
                
                <!-- Semester Statistics -->
                <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center">
                        üìä Statistik Semester
                        <select id="semesterStudentSelect" onchange="updateSemesterChart()" class="ml-4 p-2 border rounded-lg text-sm">
                            <option value="all">Semua Siswa</option>
                        </select>
                    </h3>
                    <canvas id="semesterChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab Rekap -->
        <div id="rekap-tab" class="tab-content hidden">
            <!-- Daily Recap -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow mb-8">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h3 class="text-2xl font-bold text-gray-800">üìÖ Rekap Kehadiran Harian</h3>
                    <div class="flex items-center gap-3">
                         <input type="date" id="rekapDate" onchange="renderDailyRecap()" class="p-3 border-2 border-gray-300 rounded-xl">
                         <button onclick="printDailyReport()" class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                            üñ®Ô∏è Cetak Harian
                        </button>
                    </div>
                </div>
                <div id="dailyRecapContent" class="overflow-x-auto">
                    <!-- Daily recap content will be populated here -->
                </div>
            </div>

            <!-- Meeting Recap -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow mb-8">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h3 class="text-2xl font-bold text-gray-800">üìö Rekap Kehadiran per Pertemuan</h3>
                     <button onclick="printMeetingReport()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                        üñ®Ô∏è Cetak Rekap Pertemuan
                    </button>
                </div>
                <div id="attendanceRecapContent" class="overflow-x-auto">
                    <!-- Meeting recap table will be populated here -->
                </div>
            </div>

            <!-- Monthly Recap -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow mb-8">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h3 class="text-2xl font-bold text-gray-800">üóìÔ∏è Rekap Kehadiran Bulanan</h3>
                     <button onclick="printMonthlyReport()" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-6 py-3 rounded-xl transition-all hover-lift ripple">
                        üñ®Ô∏è Cetak Rekap Bulanan
                    </button>
                </div>
                <div id="monthlyRecapContent" class="overflow-x-auto">
                    <!-- Monthly recap table will be populated here -->
                </div>
            </div>

            <!-- Semester Recap -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow">
                <div id="semesterRecapContent" class="space-y-8">
                    <!-- Semester 1 and 2 tables will be populated here -->
                </div>
            </div>
        </div>


        <!-- Tab Pengaturan -->
        <div id="pengaturan-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Storage Settings -->
                <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">‚öôÔ∏è Pengaturan Sistem</h3>
                    
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-4 text-gray-700">üíæ Penyimpanan Data</h4>
                        <div class="space-y-4">
                            <label class="flex items-center p-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50 cursor-pointer transition-all">
                                <input type="radio" name="storage" value="local" checked onchange="setStorageType('local')" class="mr-3 w-5 h-5 text-blue-600 focus:ring-blue-500">
                                <div>
                                    <span class="font-medium">Simpan di Browser (Local Storage)</span>
                                    <p class="text-sm text-gray-600">Data tersimpan permanen di browser</p>
                                </div>
                            </label>
                            <label class="flex items-center p-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50 cursor-pointer transition-all">
                                <input type="radio" name="storage" value="session" onchange="setStorageType('session')" class="mr-3 w-5 h-5 text-blue-600 focus:ring-blue-500">
                                <div>
                                    <span class="font-medium">Simpan Sementara (Session Storage)</span>
                                    <p class="text-sm text-gray-600">Data hilang saat browser ditutup</p>
                                </div>
                            </label>
                            <label class="flex items-center p-3 border-2 border-gray-200 rounded-xl hover:bg-gray-50 cursor-pointer transition-all">
                                <input type="radio" name="storage" value="memory" onchange="setStorageType('memory')" class="mr-3 w-5 h-5 text-blue-600 focus:ring-blue-500">
                                <div>
                                    <span class="font-medium">Simpan di Memori (Tidak Permanen)</span>
                                    <p class="text-sm text-gray-600">Data hilang saat halaman di-refresh</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold mb-4 text-gray-700">üóÇÔ∏è Manajemen Data</h4>
                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="exportData()" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-3 rounded-xl transition-all hover-lift">
                                üì§ Export Data JSON
                            </button>
                            <label class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-3 rounded-xl transition-all hover-lift cursor-pointer text-center">
                                üì• Import Data JSON
                                <input type="file" id="importFile" class="hidden" onchange="importData(event)">
                            </label>
                            <button onclick="clearAllData()" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white p-3 rounded-xl transition-all hover-lift">
                                üóëÔ∏è Hapus Semua Data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Info -->
                <div class="bg-white rounded-2xl shadow-2xl p-8 card-shadow">
                    <h3 class="text-2xl font-bold mb-6 text-gray-800">üìä Informasi Sistem</h3>
                    
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-200">
                            <h4 class="text-lg font-semibold mb-3 text-blue-800">Status Penyimpanan</h4>
                            <p class="text-blue-700">Mode: <span id="storageStatus" class="font-bold">Local Storage</span></p>
                            <p class="text-blue-700">Status: <span class="font-bold text-green-600">Aktif</span></p>
                        </div>

                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-xl border border-green-200">
                            <h4 class="text-lg font-semibold mb-3 text-green-800">Data Tersimpan</h4>
                            <p class="text-green-700">Total Siswa: <span id="totalDataCount" class="font-bold">0</span></p>
                            <p class="text-green-700">Total Kelas: <span id="totalClassesCount" class="font-bold">9</span></p>
                            <p class="text-green-700">Terakhir Disimpan: <span id="lastSaved" class="font-bold">-</span></p>
                        </div>

                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-xl border border-purple-200">
                            <h4 class="text-lg font-semibold mb-3 text-purple-800">Statistik Penggunaan</h4>
                            <p class="text-purple-700">Sesi Aktif: <span id="sessionTime" class="font-bold">0 menit</span></p>
                            <p class="text-purple-700">Auto-save: <span class="font-bold text-green-600">Aktif (30s)</span></p>
                        </div>

                        <!-- System Health -->
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-xl border border-yellow-200">
                            <h4 class="text-lg font-semibold mb-3 text-yellow-800">Kesehatan Sistem</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>Storage Space:</span>
                                    <span id="storageSpace" class="font-bold text-green-600">Normal</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Data Integrity:</span>
                                    <span class="font-bold text-green-600">OK</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Performance:</span>
                                    <span class="font-bold text-green-600">Optimal</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Konfirmasi -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4 slide-in card-shadow">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                <h3 class="text-xl font-bold mb-4 text-gray-800">Konfirmasi Tindakan</h3>
                <p id="confirmMessage" class="text-gray-600 mb-6"></p>
            </div>
            <div class="flex justify-center gap-4">
                <button onclick="closeModal('confirmModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl transition-all hover-lift">
                    ‚ùå Batal
                </button>
                <button id="confirmButton" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl transition-all hover-lift">
                    ‚úÖ Konfirmasi
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Student Modal -->
    <div id="addStudentModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4 slide-in card-shadow">
            <h3 class="text-xl font-bold mb-6 text-gray-800 text-center">Tambah Siswa Baru</h3>
            <div class="space-y-4">
                <div>
                    <label for="newStudentName" class="block text-sm font-bold text-gray-700 mb-2">Nama Siswa</label>
                    <input type="text" id="newStudentName" placeholder="Masukkan nama lengkap" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all">
                </div>
                <div>
                    <label for="newStudentNisn" class="block text-sm font-bold text-gray-700 mb-2">NISN (Opsional)</label>
                    <input type="text" id="newStudentNisn" placeholder="Masukkan NISN" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all">
                </div>
            </div>
            <div class="flex justify-center gap-4 mt-8">
                <button onclick="closeModal('addStudentModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl transition-all hover-lift">
                    Batal
                </button>
                <button onclick="submitNewStudent()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl transition-all hover-lift">
                    Simpan Siswa
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-lg font-semibold">Memproses...</p>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg hidden z-50">
        <div class="flex items-center">
            <span class="text-xl mr-2">‚úÖ</span>
            <span id="successMessage">Berhasil!</span>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES & INITIALIZATION ---
        let currentClass = 'XI-F'; // Set default to the new class
        let selectedDate = getFormattedDate(new Date());
        let students = {};
        let grades = {};
        let classInfo = {};
        let deletedStudents = [];
        let bulkDeleteMode = false;
        let selectedForDelete = new Set();
        let storageType = 'local';
        let sessionStartTime = Date.now();
        let autoSaveInterval;
        let monthlyChartInstance, semesterChartInstance;

        const classes = ['XI-F', 'X-A', 'X-B', 'X-C', 'X-D', 'X-E', 'X-F', 'X-G', 'X-H'];
        const subjects = {
            matematika: 'Matematika',
            fisika: 'Fisika',
            kimia: 'Kimia',
            biologi: 'Biologi',
            bahasa_indonesia: 'Bahasa Indonesia',
            bahasa_inggris: 'Bahasa Inggris'
        };
        const statusMap = { H: 'Hadir', S: 'Sakit', I: 'Izin', A: 'Alpha', B: 'Bolos', T: 'Terlambat' };
        const statusColors = { H: 'bg-green-100 text-green-800', S: 'bg-yellow-100 text-yellow-800', I: 'bg-blue-100 text-blue-800', A: 'bg-red-100 text-red-800', B: 'bg-purple-100 text-purple-800', T: 'bg-orange-100 text-orange-800' };
        const statusChartColors = { H: '#4ade80', S: '#facc15', I: '#60a5fa', A: '#f87171', B: '#c084fc', T: '#fb923c' };
        const monthMap = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const semester1Months = ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const semester2Months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];


        window.onload = function() {
            document.getElementById('classSelect').value = currentClass;
            document.getElementById('attendanceDate').value = selectedDate;
            document.getElementById('rekapDate').value = selectedDate;
            
            loadData();
            renderStudents();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            autoSaveInterval = setInterval(autoSave, 30000);
            setInterval(updateSessionTime, 60000);
            document.querySelectorAll('input[name="storage"]').forEach(radio => {
                if (radio.value === storageType) radio.checked = true;
            });
             // Add event listeners for wali kelas inputs
            document.getElementById('waliKelas').addEventListener('input', (e) => updateClassInfo('wali', e.target.value));
        };

        // --- DATA MANAGEMENT ---

        function getStorage() {
            switch (storageType) {
                case 'local': return localStorage;
                case 'session': return sessionStorage;
                default: return null; // Memory storage is handled by JS variables directly
            }
        }
        
        function getFormattedDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function calculateHistoricalAttendance(student) {
            const newHistorical = initializeEmptyHistoricalAttendance();
            if (student.dailyAttendance) {
                for (const date in student.dailyAttendance) {
                    const monthIndex = parseInt(date.substring(5, 7), 10) - 1;
                    const monthName = monthMap[monthIndex];
                    const status = student.dailyAttendance[date];
                    if (newHistorical[monthName] && newHistorical[monthName][status] !== undefined) {
                        newHistorical[monthName][status]++;
                    }
                }
            }
            student.historicalAttendance = newHistorical;
        }

        function saveData() {
            // Recalculate historical data before saving
            Object.values(students).forEach(classList => {
                classList.forEach(student => calculateHistoricalAttendance(student));
            });

            const storage = getStorage();
            if (!storage) {
                showToast('Mode memori aktif, data tidak disimpan permanen.', 'info');
                return;
            }
            try {
                const appData = {
                    students: students,
                    grades: grades,
                    classInfo: classInfo,
                    storageType: storageType
                };
                storage.setItem('absensiDigitalData', JSON.stringify(appData));
                document.getElementById('lastSaved').textContent = new Date().toLocaleTimeString('id-ID');
                showToast('Data berhasil disimpan!');
            } catch (e) {
                console.error("Error saving data:", e);
                showToast('Gagal menyimpan data. Penyimpanan mungkin penuh.', 'error');
            }
        }

        function loadData() {
            const storage = getStorage();
            const data = storage ? storage.getItem('absensiDigitalData') : null;
            if (data) {
                const appData = JSON.parse(data);
                students = appData.students || {};
                grades = appData.grades || {};
                classInfo = appData.classInfo || {};
                storageType = appData.storageType || 'local';
                setStorageType(storageType, false); // Update UI without confirmation
            } else {
                // Initialize with sample data if no data is found
                initializeEmptyData();
            }
            // Ensure all classes and structures exist
            classes.forEach(cls => {
                if (!students[cls]) students[cls] = [];
                if (!grades[cls]) grades[cls] = {};
                if (!classInfo[cls]) classInfo[cls] = { wali: '' };
                // Ensure dailyAttendance structure exists for all students
                students[cls].forEach(student => {
                    if (!student.dailyAttendance) student.dailyAttendance = {};
                    if (!student.historicalAttendance) student.historicalAttendance = initializeEmptyHistoricalAttendance();
                    // Ensure new grading structure exists
                    if (!grades[cls][student.id] || !grades[cls][student.id]['bahasa_inggris']) {
                        if(!grades[cls][student.id]) grades[cls][student.id] = {};
                        grades[cls][student.id]['bahasa_inggris'] = { tugas1: null, tugas2: null, tugas3: null, tugas4: null, mid: null, uas: null };
                    }
                });
            });
        }
        
        function initializeEmptyData() {
            classes.forEach(cls => {
                students[cls] = [];
                grades[cls] = {};
                classInfo[cls] = { wali: '' };
            });
            saveData();
        }

        function autoSave() {
            if (storageType !== 'memory') {
                saveData();
                showToast('Data disimpan otomatis.', 'info');
            }
        }

        // --- UI & RENDERING ---

        function renderStudents() {
            const studentListBody = document.getElementById('studentList');
            studentListBody.innerHTML = '';
            const currentStudents = students[currentClass] || [];

            if (currentStudents.length === 0) {
                studentListBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-500">Belum ada siswa di kelas ini. Klik "Tambah Siswa" untuk memulai.</td></tr>`;
            } else {
                currentStudents.forEach((student, index) => {
                    const studentStatus = student.dailyAttendance[selectedDate] || 'H'; // Default to 'Hadir'
                    const row = document.createElement('tr');
                    row.className = 'student-row border-b border-gray-200';
                    row.id = `student-${student.id}`;
                    if (bulkDeleteMode) {
                        row.classList.add('delete-preparing');
                        row.onclick = () => selectStudentForDelete(student.id);
                        if (selectedForDelete.has(student.id)) {
                            row.classList.add('selected-for-delete');
                        }
                    }

                    const statusButtons = Object.keys(statusMap).map(s =>
                        `<button onclick="event.stopPropagation(); changeStatus('${student.id}', '${s}')" 
                                 class="status-btn px-2 py-1 rounded-md text-xs font-semibold
                                        ${studentStatus === s ? statusColors[s] + ' ring-2 ring-offset-1 ring-blue-500' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                            ${s}
                        </button>`
                    ).join('');

                    row.innerHTML = `
                        <td class="p-4">${index + 1}</td>
                        <td class="p-4 font-medium text-gray-800">
                            <span contenteditable="true" onblur="editStudentName('${student.id}', this.innerText)" class="p-1 rounded-md cursor-pointer">${student.name}</span>
                        </td>
                        <td class="p-4 text-gray-600">${student.nisn}</td>
                        <td class="p-4 text-center">
                            <div class="flex justify-center gap-1 flex-wrap">${statusButtons}</div>
                        </td>
                        <td class="p-4 text-center">
                            <button onclick="event.stopPropagation(); deleteStudent('${student.id}')" class="text-red-500 hover:text-red-700 transition-colors text-xl">
                                üóëÔ∏è
                            </button>
                        </td>
                    `;
                    studentListBody.appendChild(row);
                });
            }
            updateCounts();
            updateSystemInfo();
            updateStudentSelects();
            loadClassInfo();
        }
        
        function updateCounts() {
            const currentStudents = students[currentClass] || [];
            const counts = { H: 0, S: 0, I: 0, A: 0, B: 0, T: 0 };
            currentStudents.forEach(s => {
                const status = s.dailyAttendance[selectedDate] || 'H';
                if (counts[status] !== undefined) {
                    counts[status]++;
                }
            });
            document.getElementById('hadirCount').textContent = counts.H;
            document.getElementById('sakitCount').textContent = counts.S;
            document.getElementById('izinCount').textContent = counts.I;
            document.getElementById('alphaCount').textContent = counts.A;
            document.getElementById('bolosCount').textContent = counts.B;
            document.getElementById('terlambatCount').textContent = counts.T;
            document.getElementById('totalStudents').textContent = currentStudents.length;
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('id-ID', options);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            const activeTab = document.getElementById(`${tabName}-tab`);
            activeTab.classList.remove('hidden');
            activeTab.classList.add('fade-in');

            if (tabName === 'statistik') updateAllCharts();
            else if (tabName === 'rekap') {
                renderDailyRecap();
                renderAttendanceRecapTable();
                renderMonthlyRecapTable();
                renderSemesterRecapTable();
            }
            else if (tabName === 'penilaian') renderPenilaian();
            else if (tabName === 'pengaturan') updateSystemInfo();
        }
        
        function changeClass() {
            currentClass = document.getElementById('classSelect').value;
            renderStudents();
            if (document.getElementById('penilaian-tab')?.classList.contains('fade-in')) renderPenilaian();
            if (document.getElementById('statistik-tab').classList.contains('fade-in')) updateAllCharts();
            if (document.getElementById('rekap-tab').classList.contains('fade-in')) {
                renderDailyRecap();
                renderAttendanceRecapTable();
                renderMonthlyRecapTable();
                renderSemesterRecapTable();
            }
        }
        
        function changeDate(newDate) {
            selectedDate = newDate;
            document.getElementById('attendanceDate').value = selectedDate;
            document.getElementById('rekapDate').value = selectedDate;
            renderStudents();
        }

        // --- STUDENT & ATTENDANCE ACTIONS ---

        function editStudentName(studentId, newName) {
            const student = students[currentClass].find(s => s.id == studentId);
            const trimmedName = newName.trim();
            if (student && trimmedName && student.name !== trimmedName) {
                student.name = trimmedName;
                showToast(`Nama siswa diperbarui menjadi "${student.name}".`);
            } else {
                // If name is empty, revert to original
                renderStudents();
            }
        }

        function addStudent() {
            document.getElementById('newStudentName').value = '';
            document.getElementById('newStudentNisn').value = '';
            const modal = document.getElementById('addStudentModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function submitNewStudent() {
            const nameInput = document.getElementById('newStudentName');
            const nisnInput = document.getElementById('newStudentNisn');
            const name = nameInput.value.trim();

            if (!name) {
                showToast('Nama siswa tidak boleh kosong.', 'error');
                return;
            }
            
            const nisn = nisnInput.value.trim();
            const studentId = Date.now() + Math.random();
            const newStudent = {
                id: studentId,
                name: name,
                nisn: nisn || 'N/A',
                historicalAttendance: initializeEmptyHistoricalAttendance(),
                dailyAttendance: {}
            };

            if (!students[currentClass]) students[currentClass] = [];
            students[currentClass].push(newStudent);

            if (!grades[currentClass]) grades[currentClass] = {};
            grades[currentClass][studentId] = {}; // Initialize grades object for the student

            renderStudents();
            closeModal('addStudentModal');
            showToast(`Siswa ${name} berhasil ditambahkan.`);
        }

        function deleteStudent(studentId) {
            showModal(`Apakah Anda yakin ingin menghapus siswa ini? Tindakan ini tidak dapat dibatalkan.`, () => {
                const studentIndex = students[currentClass].findIndex(s => s.id == studentId);
                if (studentIndex > -1) {
                    const deleted = students[currentClass].splice(studentIndex, 1);
                    deletedStudents.push(...deleted);
                    updateUndoUI();
                    delete grades[currentClass][studentId];
                    const row = document.getElementById(`student-${studentId}`);
                    if (row) {
                        row.classList.add('slide-out');
                        setTimeout(() => renderStudents(), 500);
                    } else {
                        renderStudents();
                    }
                    showToast('Siswa berhasil dihapus.');
                }
            });
        }

        function changeStatus(studentId, newStatus) {
            const student = students[currentClass].find(s => s.id == studentId);
            if (student) {
                student.dailyAttendance[selectedDate] = newStatus;
                renderStudents(); // Re-render all for simplicity, could be optimized
            }
        }

        function markAllPresent() {
            showModal(`Tandai semua siswa sebagai "Hadir" untuk tanggal ${selectedDate}?`, () => {
                students[currentClass].forEach(s => {
                    s.dailyAttendance[selectedDate] = 'H';
                });
                renderStudents();
                showToast('Semua siswa ditandai Hadir.');
            });
        }
        
        // --- BULK DELETE ---

        function toggleBulkDelete() {
            bulkDeleteMode = !bulkDeleteMode;
            const controls = document.getElementById('bulkDeleteControls');
            const btn = document.getElementById('bulkDeleteBtn');
            if (bulkDeleteMode) {
                controls.classList.remove('hidden');
                controls.classList.add('fade-in');
                btn.innerHTML = '‚ùå Batalkan Hapus Massal';
                btn.classList.remove('from-red-500', 'to-red-600');
                btn.classList.add('from-gray-500', 'to-gray-600');
            } else {
                controls.classList.add('hidden');
                btn.innerHTML = 'üóëÔ∏è Hapus Massal';
                btn.classList.add('from-red-500', 'to-red-600');
                btn.classList.remove('from-gray-500', 'to-gray-600');
                selectedForDelete.clear();
            }
            renderStudents();
        }

        function selectStudentForDelete(studentId) {
            if (!bulkDeleteMode) return;
            const row = document.getElementById(`student-${studentId}`);
            if (selectedForDelete.has(studentId)) {
                selectedForDelete.delete(studentId);
                row.classList.remove('selected-for-delete');
            } else {
                selectedForDelete.add(studentId);
                row.classList.add('selected-for-delete');
            }
            updateSelectedCount();
        }
        
        function selectAllForDelete() {
            students[currentClass].forEach(s => selectedForDelete.add(s.id));
            updateSelectedCount();
            renderStudents();
        }

        function deselectAllForDelete() {
            selectedForDelete.clear();
            updateSelectedCount();
            renderStudents();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedForDelete.size;
        }

        function deleteSelectedStudents() {
            if (selectedForDelete.size === 0) {
                showToast('Tidak ada siswa yang dipilih.', 'info');
                return;
            }
            showModal(`Anda akan menghapus ${selectedForDelete.size} siswa. Lanjutkan?`, () => {
                const remainingStudents = [];
                const newlyDeleted = [];
                students[currentClass].forEach(s => {
                    if (selectedForDelete.has(s.id)) {
                        newlyDeleted.push(s);
                        delete grades[currentClass][s.id];
                    } else {
                        remainingStudents.push(s);
                    }
                });
                students[currentClass] = remainingStudents;
                deletedStudents.push(...newlyDeleted);
                updateUndoUI();
                selectedForDelete.clear();
                toggleBulkDelete(); // Exit bulk delete mode
                renderStudents();
                showToast(`${newlyDeleted.length} siswa berhasil dihapus.`);
            });
        }
        
        // --- UNDO ---
        
        function updateUndoUI() {
            const undoContainer = document.getElementById('undoContainer');
            const undoCount = document.getElementById('undoCount');
            if (deletedStudents.length > 0) {
                undoCount.textContent = deletedStudents.length;
                undoContainer.classList.remove('hidden');
                undoContainer.classList.add('bounce');
            } else {
                undoContainer.classList.add('hidden');
            }
        }

        function undoDelete() {
            if (deletedStudents.length > 0) {
                const lastDeleted = deletedStudents.pop();
                students[currentClass].push(lastDeleted);
                if (!grades[currentClass][lastDeleted.id]) {
                     grades[currentClass][lastDeleted.id] = {};
                }
                renderStudents();
                updateUndoUI();
                showToast(`Tindakan terakhir dibatalkan. ${lastDeleted.name} dipulihkan.`);
            }
        }

        // --- CHARTS & STATISTICS ---

        function updateAllCharts() {
            updateStudentSelects();
            updateMonthlyChart();
            updateSemesterChart();
        }

        function updateStudentSelects() {
            const selects = [document.getElementById('monthlyStudentSelect'), document.getElementById('semesterStudentSelect')];
            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = '<option value="all">Semua Siswa</option>';
                students[currentClass].forEach(s => {
                    select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                });
                select.value = currentValue;
            });
        }

        function getAggregatedAttendance(studentId = 'all') {
            const data = { H: 0, S: 0, I: 0, A: 0, B: 0, T: 0 };
            const studentList = studentId === 'all' ? students[currentClass] : students[currentClass].filter(s => s.id == studentId);
            
            studentList.forEach(student => {
                for (const month in student.historicalAttendance) {
                    for (const status in student.historicalAttendance[month]) {
                        data[status] += student.historicalAttendance[month][status];
                    }
                }
            });
            return data;
        }

        function updateMonthlyChart() {
            const studentId = document.getElementById('monthlyStudentSelect').value;
            const data = getAggregatedAttendance(studentId);
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            if (monthlyChartInstance) monthlyChartInstance.destroy();

            monthlyChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.values(statusMap),
                    datasets: [{
                        label: 'Statistik Bulanan',
                        data: Object.values(data),
                        backgroundColor: Object.values(statusChartColors),
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: `Statistik Historis Bulanan` } } }
            });
        }

        function updateSemesterChart() {
            const studentId = document.getElementById('semesterStudentSelect').value;
            const data = getAggregatedAttendance(studentId);
            const ctx = document.getElementById('semesterChart').getContext('2d');

            if (semesterChartInstance) semesterChartInstance.destroy();

            semesterChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.values(statusMap),
                    datasets: [{
                        label: 'Total Kehadiran Semester',
                        data: Object.values(data),
                        backgroundColor: Object.values(statusChartColors),
                    }]
                },
                options: { responsive: true, indexAxis: 'y', plugins: { legend: { display: false }, title: { display: true, text: `Total Kehadiran Historis Semester` } } }
            });
        }
        
        // --- REKAP & EXPORT ---
        
        function renderDailyRecap() {
            const recapDate = document.getElementById('rekapDate').value;
            const contentDiv = document.getElementById('dailyRecapContent');
            const counts = { H: 0, S: 0, I: 0, A: 0, B: 0, T: 0 };
            const absentList = [];

            students[currentClass].forEach(student => {
                const status = student.dailyAttendance[recapDate] || 'H';
                counts[status]++;
                if (status !== 'H') {
                    absentList.push({ name: student.name, status: statusMap[status] });
                }
            });

            let html = `<div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">`;
            Object.keys(counts).forEach(key => {
                html += `
                    <div class="p-4 rounded-xl text-center text-white ${statusColors[key].replace('-100', '-500').replace('text-green-800', 'bg-green-500').replace('text-yellow-800', 'bg-yellow-500').replace('text-blue-800', 'bg-blue-500').replace('text-red-800', 'bg-red-500').replace('text-purple-800', 'bg-purple-500').replace('text-orange-800', 'bg-orange-500')}">
                        <div class="text-2xl font-bold">${counts[key]}</div>
                        <div class="text-sm">${statusMap[key]}</div>
                    </div>`;
            });
            html += `</div>`;

            if (absentList.length > 0) {
                html += `<h4 class="text-lg font-semibold mb-4">Daftar Siswa Tidak Hadir:</h4>`;
                html += `<table class="w-full text-sm"><thead><tr class="bg-gray-100"><th class="p-2 text-left">Nama</th><th class="p-2 text-left">Keterangan</th></tr></thead><tbody>`;
                absentList.forEach(item => {
                    html += `<tr class="border-b"><td class="p-2">${item.name}</td><td class="p-2">${item.status}</td></tr>`;
                });
                html += `</tbody></table>`;
            } else {
                html += `<p class="text-center text-green-600 font-semibold p-4">üéâ Semua siswa hadir pada tanggal ini!</p>`;
            }

            contentDiv.innerHTML = html;
        }
        
        function renderAttendanceRecapTable() {
            const contentDiv = document.getElementById('attendanceRecapContent');
            const currentStudents = students[currentClass] || [];

            const allDates = new Set();
            currentStudents.forEach(student => {
                Object.keys(student.dailyAttendance).forEach(date => allDates.add(date));
            });
            const sortedDates = Array.from(allDates).sort();

            let table = `<table class="w-full text-sm text-center">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-3 text-left">No</th>
                        <th class="p-3 text-left">Nama Siswa</th>`;
            
            sortedDates.forEach((date, index) => {
                table += `<th class="p-2" title="${new Date(date).toLocaleDateString('id-ID')}">P-${index + 1}</th>`;
            });

            table += `</tr></thead><tbody>`;

            if (currentStudents.length === 0) {
                table += `<tr><td colspan="${sortedDates.length + 2}" class="text-center p-8 text-gray-500">Belum ada data kehadiran.</td></tr>`;
            } else {
                currentStudents.forEach((student, index) => {
                    table += `<tr class="border-b hover:bg-gray-50">
                        <td class="p-3 text-left">${index + 1}</td>
                        <td class="p-3 text-left font-medium">${student.name}</td>`;
                    
                    sortedDates.forEach(date => {
                        const status = student.dailyAttendance[date] || '-';
                        const statusColorClass = getStatusColorClass(status);
                        table += `<td class="p-2 font-semibold ${statusColorClass}">${status}</td>`;
                    });

                    table += `</tr>`;
                });
            }

            table += `</tbody></table>`;

            if(sortedDates.length > 0) {
                table += `<div class="mt-4 text-xs text-gray-600">`;
                sortedDates.forEach((date, index) => {
                    table += `<span class="mr-4"><b>P-${index + 1}:</b> ${new Date(date).toLocaleDateString('id-ID', {day: '2-digit', month: 'short'})}</span>`;
                });
                table += `</div>`;
            }

            contentDiv.innerHTML = table;
        }

        function renderMonthlyRecapTable() {
            const contentDiv = document.getElementById('monthlyRecapContent');
            const currentStudents = students[currentClass] || [];

            let table = `<table class="w-full text-sm text-center">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-3 text-left" rowspan="2">No</th>
                        <th class="p-3 text-left" rowspan="2">Nama Siswa</th>`;
            
            monthMap.forEach(month => {
                table += `<th class="p-2 border-b border-l" colspan="6">${month}</th>`;
            });
            table += `<th class="p-3 text-center font-bold" rowspan="2">Total Hadir</th>`;
            table += `</tr><tr>`;
            monthMap.forEach(month => {
                Object.keys(statusMap).forEach(status => {
                    table += `<th class="p-1 border-l text-xs ${getStatusColorClass(status)}">${status}</th>`;
                });
            });
            table += `</tr></thead><tbody>`;

            if (currentStudents.length === 0) {
                table += `<tr><td colspan="${monthMap.length * 6 + 3}" class="text-center p-8 text-gray-500">Belum ada data kehadiran.</td></tr>`;
            } else {
                 currentStudents.forEach((student, index) => {
                    let totalHadir = 0;
                    table += `<tr class="border-b hover:bg-gray-50">
                        <td class="p-2 text-left">${index + 1}</td>
                        <td class="p-2 text-left font-medium">${student.name}</td>`;
                    
                    monthMap.forEach(month => {
                        Object.keys(statusMap).forEach(status => {
                            const count = student.historicalAttendance[month]?.[status] ?? 0;
                            if(status === 'H') {
                                totalHadir += count;
                            }
                            table += `<td class="p-2 border-l">${count > 0 ? count : '-'}</td>`;
                        });
                    });
                    table += `<td class="p-2 border-l font-bold bg-green-50">${totalHadir}</td>`;
                    table += `</tr>`;
                });
            }

            table += `</tbody></table>`;
            contentDiv.innerHTML = table;
        }
        
        function renderSemesterRecapTable() {
            const contentDiv = document.getElementById('semesterRecapContent');
            const currentStudents = students[currentClass] || [];
            let html = '';

            [1, 2].forEach(semester => {
                const semesterMonths = semester === 1 ? semester1Months : semester2Months;
                let table = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-xl font-bold text-gray-700">Semester ${semester}</h4>
                            <button onclick="printSemesterReport(${semester})" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-xl transition-all hover-lift ripple text-sm">
                                üñ®Ô∏è Cetak Semester ${semester}
                            </button>
                        </div>
                        <table class="w-full text-sm text-center">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 text-left">No</th>
                                    <th class="p-3 text-left">Nama Siswa</th>`;
                Object.keys(statusMap).forEach(status => {
                    table += `<th class="p-2 ${getStatusColorClass(status)}">${status}</th>`;
                });
                table += `<th class="p-2 font-bold">Persentase</th>
                          <th class="p-2 font-bold">Status</th>
                          </tr></thead><tbody>`;
                
                if (currentStudents.length === 0) {
                    table += `<tr><td colspan="${Object.keys(statusMap).length + 4}" class="text-center p-8 text-gray-500">Belum ada data.</td></tr>`;
                } else {
                    currentStudents.forEach((student, index) => {
                        const totals = { H: 0, S: 0, I: 0, A: 0, B: 0, T: 0 };
                        let totalPertemuan = 0;
                        semesterMonths.forEach(month => {
                            if (student.historicalAttendance[month]) {
                                Object.keys(totals).forEach(status => {
                                    const count = student.historicalAttendance[month][status] || 0;
                                    totals[status] += count;
                                    totalPertemuan += count;
                                });
                            }
                        });

                        const persentase = totalPertemuan > 0 ? ((totals.H / totalPertemuan) * 100) : 0;
                        const statusKehadiran = persentase >= 85 ? '<span class="text-green-600 font-bold">Baik</span>' : '<span class="text-red-600 font-bold">Perlu Perhatian</span>';

                        table += `<tr class="border-b hover:bg-gray-50">
                            <td class="p-2 text-left">${index + 1}</td>
                            <td class="p-2 text-left font-medium">${student.name}</td>`;
                        Object.keys(statusMap).forEach(status => {
                            table += `<td class="p-2">${totals[status] > 0 ? totals[status] : '-'}</td>`;
                        });
                        table += `<td class="p-2 font-bold">${persentase.toFixed(1)}%</td>`;
                        table += `<td class="p-2">${statusKehadiran}</td>`;
                        table += `</tr>`;
                    });
                }
                table += `</tbody></table></div>`;
                html += table;
            });

            contentDiv.innerHTML = html;
        }

        function getStatusColorClass(status) {
            switch(status) {
                case 'H': return 'text-green-600';
                case 'S': return 'text-yellow-600';
                case 'I': return 'text-blue-600';
                case 'A': return 'text-red-600';
                case 'B': return 'text-purple-600';
                case 'T': return 'text-orange-600';
                default: return 'text-gray-400';
            }
        }
        
        function printDailyReport() {
            const recapDate = document.getElementById('rekapDate').value;
            const recapContent = document.getElementById('dailyRecapContent').innerHTML;
            const wali = classInfo[currentClass]?.wali || 'Belum diisi';
            const printWindow = window.open('', '', 'height=800,width=1000');
            printWindow.document.write('<html><head><title>Rekap Absensi Harian</title>');
            printWindow.document.write('<style>body{font-family:sans-serif;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ccc; padding:8px; text-align:left;} th{background-color:#f2f2f2;} .header{text-align:center; margin-bottom: 20px;} .footer{margin-top: 40px; text-align: right;} .grid{display:none!important;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<div class="header"><h1>Rekap Absensi Harian Kelas ${currentClass}</h1><h2>Tanggal: ${new Date(recapDate).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h2></div>`);
            printWindow.document.write(recapContent);
            printWindow.document.write(`<div class="footer"><p>Banggai, ${new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</p><br/><br/><br/><p><strong>${wali}</strong></p></div>`);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        function printMeetingReport() {
            const rekapContent = document.getElementById('attendanceRecapContent').innerHTML;
            const wali = classInfo[currentClass]?.wali || 'Belum diisi';
            const printWindow = window.open('', '', 'height=800,width=1000');
            printWindow.document.write('<html><head><title>Rekap Absensi per Pertemuan</title>');
            printWindow.document.write('<style>body{font-family:sans-serif;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ccc; padding:8px; text-align:left;} th{background-color:#f2f2f2;} .header{text-align:center; margin-bottom: 20px;} .footer{margin-top: 40px; text-align: right;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<div class="header"><h1>Rekap Absensi per Pertemuan Kelas ${currentClass}</h1><h2>SMA Negeri 1 Banggai</h2></div>`);
            printWindow.document.write(rekapContent);
            printWindow.document.write(`<div class="footer"><p>Banggai, ${new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</p><br/><br/><br/><p><strong>${wali}</strong></p></div>`);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        function printMonthlyReport() {
            const rekapContent = document.getElementById('monthlyRecapContent').innerHTML;
            const wali = classInfo[currentClass]?.wali || 'Belum diisi';
            const printWindow = window.open('', '', 'height=800,width=1000');
            printWindow.document.write('<html><head><title>Rekap Absensi Bulanan</title>');
            printWindow.document.write('<style>body{font-family:sans-serif;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ccc; padding:4px; text-align:center; font-size: 10px;} th{background-color:#f2f2f2;} .header{text-align:center; margin-bottom: 20px;} .footer{margin-top: 40px; text-align: right;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<div class="header"><h1>Rekap Absensi Bulanan Kelas ${currentClass}</h1><h2>SMA Negeri 1 Banggai</h2></div>`);
            printWindow.document.write(rekapContent);
            printWindow.document.write(`<div class="footer"><p>Banggai, ${new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</p><br/><br/><br/><p><strong>${wali}</strong></p></div>`);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        function printSemesterReport(semester) {
            const semesterMonths = semester === 1 ? semester1Months : semester2Months;
            const currentStudents = students[currentClass] || [];
            const wali = classInfo[currentClass]?.wali || 'Belum diisi';

            let table = `<table class="w-full text-sm text-center">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 text-left">No</th>
                                    <th class="p-3 text-left">Nama Siswa</th>`;
                Object.keys(statusMap).forEach(status => {
                    table += `<th class="p-2">${status}</th>`;
                });
                table += `<th class="p-2 font-bold">Persentase</th>
                          <th class="p-2 font-bold">Status</th>
                          </tr></thead><tbody>`;
                
                if (currentStudents.length === 0) {
                    table += `<tr><td colspan="${Object.keys(statusMap).length + 4}" class="text-center p-8">Belum ada data.</td></tr>`;
                } else {
                    currentStudents.forEach((student, index) => {
                        const totals = { H: 0, S: 0, I: 0, A: 0, B: 0, T: 0 };
                        let totalPertemuan = 0;
                        semesterMonths.forEach(month => {
                            if (student.historicalAttendance[month]) {
                                Object.keys(totals).forEach(status => {
                                    const count = student.historicalAttendance[month][status] || 0;
                                    totals[status] += count;
                                    totalPertemuan += count;
                                });
                            }
                        });

                        const persentase = totalPertemuan > 0 ? ((totals.H / totalPertemuan) * 100) : 0;
                        const statusKehadiran = persentase >= 85 ? 'Baik' : 'Perlu Perhatian';

                        table += `<tr class="border-b">
                            <td class="p-2 text-left">${index + 1}</td>
                            <td class="p-2 text-left font-medium">${student.name}</td>`;
                        Object.keys(statusMap).forEach(status => {
                            table += `<td class="p-2">${totals[status] > 0 ? totals[status] : '-'}</td>`;
                        });
                        table += `<td class="p-2 font-bold">${persentase.toFixed(1)}%</td>`;
                        table += `<td class="p-2">${statusKehadiran}</td>`;
                        table += `</tr>`;
                    });
                }
                table += `</tbody></table>`;

            const printWindow = window.open('', '', 'height=800,width=1000');
            printWindow.document.write('<html><head><title>Rekap Absensi Semester</title>');
            printWindow.document.write('<style>body{font-family:sans-serif;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ccc; padding:8px; text-align:center;} th{background-color:#f2f2f2;} .header{text-align:center; margin-bottom: 20px;} .footer{margin-top: 40px; text-align: right;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<div class="header"><h1>Rekap Absensi Semester ${semester} Kelas ${currentClass}</h1><h2>SMA Negeri 1 Banggai</h2></div>`);
            printWindow.document.write(table);
            printWindow.document.write(`<div class="footer"><p>Banggai, ${new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</p><br/><br/><br/><p><strong>${wali}</strong></p></div>`);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        function exportToExcel() {
            const dataToExport = [];
            const header = ['No', 'Nama Siswa', 'NISN', `Status (${selectedDate})`];
            dataToExport.push(header);

            students[currentClass].forEach((student, index) => {
                const status = student.dailyAttendance[selectedDate] || 'H';
                const row = [
                    index + 1,
                    student.name,
                    student.nisn,
                    statusMap[status],
                ];
                dataToExport.push(row);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Absensi ${currentClass}`);
            XLSX.writeFile(wb, `Absensi_Harian_${currentClass}_${selectedDate}.xlsx`);
            showToast('Data sedang diexport ke Excel...');
        }
        
        // --- PENGATURAN ---
        
        function setStorageType(type, confirm = true) {
            if (confirm) {
                showModal(`Mengganti mode penyimpanan ke "${type}" akan memuat ulang data dari penyimpanan tersebut. Lanjutkan?`, () => {
                    storageType = type;
                    updateStorageStatus();
                    loadData();
                    renderStudents();
                    showToast(`Mode penyimpanan diubah ke ${type}.`);
                });
            } else {
                storageType = type;
                updateStorageStatus();
            }
        }
        
        function updateStorageStatus() {
            const statusText = { local: 'Local Storage', session: 'Session Storage', memory: 'Memory' };
            document.getElementById('storageStatus').textContent = statusText[storageType];
            document.querySelector(`input[name="storage"][value="${storageType}"]`).checked = true;
        }
        
        function updateSystemInfo() {
            let total = 0;
            Object.values(students).forEach(cls => total += cls.length);
            document.getElementById('totalDataCount').textContent = total;
            document.getElementById('totalClassesCount').textContent = classes.length;
            updateStorageSpace();
        }
        
        function updateStorageSpace() {
            try {
                const storage = getStorage();
                if (storage) {
                    const allData = JSON.stringify(storage);
                    const sizeKB = (allData.length / 1024).toFixed(2);
                    document.getElementById('storageSpace').textContent = `${sizeKB} KB`;
                } else {
                    document.getElementById('storageSpace').textContent = 'N/A';
                }
            } catch (e) {
                 document.getElementById('storageSpace').textContent = 'Error';
            }
        }

        function updateSessionTime() {
            const minutes = Math.floor((Date.now() - sessionStartTime) / 60000);
            document.getElementById('sessionTime').textContent = `${minutes} menit`;
        }
        
        function clearAllData() {
            showModal('APAKAH ANDA YAKIN? Semua data absensi dan nilai di semua kelas akan dihapus secara permanen. Tindakan ini tidak dapat dibatalkan.', () => {
                initializeEmptyData();
                saveData();
                loadData();
                renderStudents();
                showToast('Semua data telah dihapus.', 'warning');
            });
        }

        function exportData() {
            const appData = { students, grades, classInfo };
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `absensi_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data JSON sedang diexport...');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.students) {
                        showModal('Import akan menimpa semua data yang ada. Lanjutkan?', () => {
                            students = importedData.students;
                            grades = importedData.grades || {};
                            classInfo = importedData.classInfo || {};
                            saveData();
                            loadData();
                            renderStudents();
                            showToast('Data berhasil diimport.');
                        });
                    } else {
                        showToast('File JSON tidak valid.', 'error');
                    }
                } catch (err) {
                    showToast('Gagal membaca file. Pastikan formatnya JSON.', 'error');
                    console.error(err);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }
        
        function updateClassInfo(field, value) {
            if (!classInfo[currentClass]) {
                classInfo[currentClass] = { wali: '' };
            }
            classInfo[currentClass][field] = value;
        }

        function loadClassInfo() {
            const info = classInfo[currentClass] || { wali: '' };
            document.getElementById('waliKelas').value = info.wali;
        }

        // --- UTILITIES (Modals, Toasts, etc.) ---

        function showModal(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.onclick = () => {
                closeModal('confirmModal');
                onConfirm();
            };
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('successToast');
            const toastMessage = document.getElementById('successMessage');
            
            toast.classList.remove('bg-green-500', 'bg-red-500', 'bg-blue-500', 'bg-yellow-500');
            let icon = '‚úÖ';
            if (type === 'success') toast.classList.add('bg-green-500');
            else if (type === 'error') { toast.classList.add('bg-red-500'); icon = '‚ùå'; }
            else if (type === 'info') { toast.classList.add('bg-blue-500'); icon = '‚ÑπÔ∏è'; }
            else if (type === 'warning') { toast.classList.add('bg-yellow-500'); icon = '‚ö†Ô∏è'; }

            toastMessage.innerHTML = `<span class="text-xl mr-2">${icon}</span> ${message}`;
            toast.classList.remove('hidden');
            toast.classList.add('fade-in');

            setTimeout(() => {
                toast.classList.add('hidden');
                toast.classList.remove('fade-in');
            }, 3000);
        }

        function initializeEmptyHistoricalAttendance() {
            const attendance = {};
            monthMap.forEach(month => {
                attendance[month] = { H: 0, S: 0, I: 0, A: 0, B: 0, T: 0 };
            });
            return attendance;
        }

    </script>
</body>
</html>

